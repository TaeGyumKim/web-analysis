name: CD - Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # Build and Push Docker Image
  # ============================================
  docker:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}
      full_image: ${{ steps.meta.outputs.tags }}
      image_name: ${{ steps.repo.outputs.lowercase }}

    steps:
      - uses: actions/checkout@v4

      - name: Set lowercase repository name
        id: repo
        run: echo "lowercase=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo.outputs.lowercase }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Get git info
        id: git
        run: |
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_type == 'tag' && github.ref_name || '' }}" >> $GITHUB_OUTPUT
          echo "datetime=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GIT_COMMIT=${{ steps.git.outputs.commit }}
            GIT_BRANCH=${{ steps.git.outputs.branch }}
            GIT_TAG=${{ steps.git.outputs.tag }}
            GIT_VERSION=${{ steps.meta.outputs.version }}
            GIT_DATETIME=${{ steps.git.outputs.datetime }}
            CACHE_BUST=${{ github.sha }}
          no-cache: true

      - name: Output image info
        run: |
          echo "### ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ steps.repo.outputs.lowercase }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Validate SSH secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "::error::SSH_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::SSH_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GHCR_PAT }}" ]; then
            echo "::error::GHCR_PAT secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ vars.SSH_PORT || '22' }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "::error::Failed to scan SSH host. Check if SSH_HOST is correct and port ${{ vars.SSH_PORT || '22' }} is accessible."
            exit 1
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… Host added to known_hosts"

      - name: Create deployment directory
        run: |
          ssh -p ${{ vars.SSH_PORT || '22' }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ vars.DEPLOY_PATH || '/opt/web-perf' }}"

      - name: Copy docker-compose to server
        run: |
          scp -P ${{ vars.SSH_PORT || '22' }} -o ConnectTimeout=10 docker-compose.prod.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ vars.DEPLOY_PATH || '/opt/web-perf' }}/docker-compose.yml

      - name: Deploy to staging server
        run: |
          ssh -p ${{ vars.SSH_PORT || '22' }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e
            cd ${{ vars.DEPLOY_PATH || '/opt/web-perf' }}

            # Set environment variables
            export GITHUB_REPOSITORY=${{ needs.docker.outputs.image_name }}
            export IMAGE_TAG=${{ needs.docker.outputs.image_tag }}

            # Login to GHCR using PAT
            echo '${{ secrets.GHCR_PAT }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Stop existing containers
            docker compose down 2>/dev/null || true
            docker stop web-perf-prod 2>/dev/null || true
            docker rm web-perf-prod 2>/dev/null || true

            # Update .env file
            echo 'GITHUB_REPOSITORY=${{ needs.docker.outputs.image_name }}' > .env
            echo 'IMAGE_TAG=${{ needs.docker.outputs.image_tag }}' >> .env
            echo 'HOST_PORT=${{ vars.HOST_PORT }}' >> .env

            # Pull and deploy
            docker compose pull
            docker compose up -d
            docker image prune -f

            # Health check
            sleep 15
            curl -sf http://localhost:3000/api/health || exit 1
            echo 'âœ… Staging deployment complete!'
          "

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.docker.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Validate SSH secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "::error::SSH_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::SSH_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GHCR_PAT }}" ]; then
            echo "::error::GHCR_PAT secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ vars.SSH_PORT || '22' }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "::error::Failed to scan SSH host. Check if SSH_HOST is correct and port ${{ vars.SSH_PORT || '22' }} is accessible."
            exit 1
          }
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… Host added to known_hosts"

      - name: Create deployment directory
        run: |
          ssh -p ${{ vars.SSH_PORT || '22' }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ vars.DEPLOY_PATH || '/opt/web-perf' }}"

      - name: Copy docker-compose to server
        run: |
          scp -P ${{ vars.SSH_PORT || '22' }} -o ConnectTimeout=10 docker-compose.prod.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ vars.DEPLOY_PATH || '/opt/web-perf' }}/docker-compose.yml

      - name: Deploy to production server
        run: |
          ssh -p ${{ vars.SSH_PORT || '22' }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e
            cd ${{ vars.DEPLOY_PATH || '/opt/web-perf' }}

            # Set environment variables
            export GITHUB_REPOSITORY=${{ needs.docker.outputs.image_name }}
            export IMAGE_TAG=${{ needs.docker.outputs.image_tag }}

            # Login to GHCR using PAT
            echo '${{ secrets.GHCR_PAT }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Stop existing containers
            docker compose down 2>/dev/null || true
            docker stop web-perf-prod 2>/dev/null || true
            docker rm web-perf-prod 2>/dev/null || true

            # Backup current state
            docker compose config > docker-compose.backup.yml 2>/dev/null || true

            # Update .env file
            echo 'GITHUB_REPOSITORY=${{ needs.docker.outputs.image_name }}' > .env
            echo 'IMAGE_TAG=${{ needs.docker.outputs.image_tag }}' >> .env
            echo 'HOST_PORT=${{ vars.HOST_PORT }}' >> .env

            # Pull and deploy
            docker compose pull
            docker compose up -d

            # Wait for container to be ready
            echo 'Waiting for container to start...'
            sleep 30

            # Health check with retry
            echo 'Running health check...'
            HEALTH_OK=false
            for i in 1 2 3 4 5 6 7 8 9 10; do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo 'âœ… Health check passed!'
                HEALTH_OK=true
                break
              fi
              echo \"Attempt \$i/10 failed, retrying in 5s...\"
              sleep 5
            done

            if [ \"\$HEALTH_OK\" != \"true\" ]; then
              echo 'âš ï¸ Health check failed, but keeping container running for debugging'
              echo 'Check logs with: docker logs web-perf-prod'
            fi

            docker image prune -f
            echo 'âœ… Production deployment complete!'
          "

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.docker.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Create Release (on tag)
  # ============================================
  release:
    name: Create Release
    needs: [docker, deploy-production]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## Changes
            ${{ steps.changelog.outputs.changelog }}

            ## Docker Image
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ needs.docker.outputs.image_name }}:${{ github.ref_name }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Deploy to GitHub Pages (Static)
  # ============================================
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Generate static site
        run: npm run generate
        env:
          NODE_ENV: production

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.output/public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
