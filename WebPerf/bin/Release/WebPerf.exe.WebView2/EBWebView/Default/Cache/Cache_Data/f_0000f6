/*****************************************************************************
 * 파일명 : JHSCIAjaxCommon.js
 * 작성일 : 2010.03.18
 * 작성자 : serverside
 * 설  명 : 서버로 요청한 데이터 정보를 가져올 때 사용 하도록 함
 *          기본으로 drw 기능을 사용
 * Dependency  : engine.js, bottom.js, ExtGridCommon.js, JHSCICommon.js
 * ===========================================================================
 * 변경이력:
 * DATE                AUTHOR        DESCRIPTION
 * ---------------------------------------------------------------------------
 * 변경 이력은 이곳에 추가 합니다.
 *****************************************************************************/

// Provide a default path to dwr.engine
if (dwr == null) var dwr = {};
if (dwr.engine == null) dwr.engine = {};
if (DWREngine == null) var DWREngine = dwr.engine;

if (Action == null) var Action = {};
Action._path = '/dwr';
Action.getInstance = function(callback) {
    dwr.engine._execute(Action._path, 'Action', 'getInstance', callback);
}
Action.init = function(callback) {
    dwr.engine._execute(Action._path, 'Action', 'init', callback);
}
Action.service = function(p0, p1, callback) {
    dwr.engine._execute(Action._path, 'Action', 'service', p0, p1, false, false, callback);
}


//data를 암호화 여브에 사용되는 flag
// true = 암호화, false = non-암호화
var _isEncription = true;
// process bar 사용여부 , default Y
var _useProgressBarYn = "Y";
// 모들 프로세스바 사용 여부, 기본 설정 사용안함
var _useModalProgressBarYn = "N";
// 가로위치
var _xPosition = "";
// 세로 위치
var _yPosition = "";

var _isGridMakskYn = "N";
var _gridObject = "";
var _isGridPaging = "N";


/**
 * AjaxOption
 * 공통으로 제공하는 Ajax를 사용하기위해 설정하는 부분
 * AjaxOption.encription : 암호화 여부 true(암호화), false(non-암호화) default값으로 true
 * AjaxOption.timeout : timeout값을 지정해 서버로부터 지정된 초가 지나도 응답이 없으면 에러로 처리 ex)1000 = 1초, 10000 10초
 * AjaxOption.progressBarYn : 처리중입니다. Layer를 보여줄지 여부 "Y"(보이도록 처리), "N"(안보이도록 처리)
 * AjaxOption.xPosition : 처리중입니다. Layer의 가로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 * AjaxOption.yPosition : 처리중입니다. Layer의 세로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 * AjaxOption.isGridMakskYn : Extjs Grid내에 처리중 loadMask가 보일지 여부(default "N")
 * AjaxOption.gridObjectName : Extjs Grid내에 처리중 loadMask가 rendering될  그리드객체
 * AjaxOption.isGridPaging : 그리드 페이징 사용 여부
 * AjaxOption.async : executeAction 호출후의 자바스크립트 수행을 동기, 비동기로 할지 여부 false(동기), true(비동기) default값으로 false
 * AjaxOption.bizChkCalendarEnc : false
 */
var AjaxOption = {
    encription:false
    ,timeout:"210000"
    ,progressBarYn:"Y"
    ,modalProgressBarYn: "Y"
    ,xPosition:""
    ,yPosition:""
    ,isGridMakskYn:"N"
    ,gridObjectName:""
    ,isGridPaging:"N"
    ,async:true
    ,bizChkCalendarEnc:false
    ,encodingYn:"Y"
}

/**
 * ExtAjaxOption
 * 공통으로 제공하는 Ajax를 사용하기위해 설정하는 부분
 * AjaxOption.encription : 암호화 여부 true(암호화), false(non-암호화) default값으로 true
 * AjaxOption.timeout : timeout값을 지정해 서버로부터 지정된 초가 지나도 응답이 없으면 에러로 처리 ex)1000 = 1초, 10000 10초
 * AjaxOption.progressBarYn : 처리중입니다. Layer를 보여줄지 여부 "Y"(보이도록 처리), "N"(안보이도록 처리)
 * AjaxOption.xPosition : 처리중입니다. Layer의 가로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 * AjaxOption.yPosition : 처리중입니다. Layer의 세로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 * AjaxOption.isGridMakskYn : Extjs Grid내에 처리중 loadMask가 보일지 여부(default "N")
 * AjaxOption.gridObjectName : Extjs Grid내에 처리중 loadMask가 rendering될  그리드객체, ExtJS Grid 사용할 경우 사용
 * AjaxOption.isGridPaging : 그리드 페이징 사용 여부
 * AjaxOption.async : executeAction 호출후의 자바스크립트 수행을 동기, 비동기로 할지 여부 false(동기), true(비동기) default값으로 false
 * AjaxOption.isAdmin : false
 */
var ExtAjaxOption = {
    encription:true
    ,timeout:"50000"
    ,progressBarYn:"Y"
    ,modalProgressBarYn: "Y"
    ,xPosition:""
    ,yPosition:""
    ,isGridMakskYn:"Y"
    ,gridObjectName:""
    ,isGridPaging:"N"
    ,isAdmin:false
    ,async:true
}

/**
 * Ajax Action을 호출하는  스크립트
 * @param ajaxUrl : Action url
 * @param DataMap : DataMap
 * @param callbackFunction : Action을 호출후, 결과를 처리할 자바스크립트 function명
 * @param AjaxOption
 *          AjaxOption.encription : 암호화 여부 true(암호화), false(non-암호화) default값으로 true
 *          AjaxOption.timeout : timeout값을 지정해 서버로부터 지정된 초가 지나도 응답이 없으면 에러로 처리 ex)1000 = 1초, 10000 10초
 *          AjaxOption.progressBarYn : 처리중입니다. Layer를 보여줄지 여부 "Y"(보이도록 처리), "N"(안보이도록 처리)
 *                                    값이 없이 넘길경우에는 default값으로 "Y"
 *          AjaxOption.modalProgressBarYn :  modal한 ProgressBar를 띄움. "Y"(modal한 Layer를 보임) , "N"(Layer 보이지 않음)
 *          AjaxOption.xPosition : 처리중입니다. Layer의 가로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 *          AjaxOption.yPosition : 처리중입니다. Layer의 세로 위치값(값을 없이 넘겨줄시에에는 default으로 가운데에 보이도록 처리)
 *          AjaxOption.isGridMakskYn : Extjs Grid내에 처리중 loadMask가 보일지 여부(default "N")
 *          AjaxOption.gridObjectName : Extjs Grid내에 처리중 loadMask가 rendering될  그리드객체
 *          AjaxOption.isGridPaging  : 그리드 페이징 사용 여부
 *          AjaxOption.async  : executeAction 호출후의 자바스크립트 수행을 동기, 비동기로 할지 여부 false(동기), true(비동기) default값으로 false
 */

function executeActionDWR(ajaxUrl, DataMap, callbackFunction, option) {	 
	alert("executeAction 함수를 이용하세요.\n추후 제거될 예정입니다.")
    // bottom.js
    _timerStart();       

    if (option.encryption == undefined) {
        _isEncription = option.encription;
    } else {
        _isEncription = option.encryption;
    }
    var ajaxTimeout = option.timeout;
    _useProgressBarYn = option.progressBarYn;
    _useModalProgressBarYn = option.modalProgressBarYn;
    _xPosition = option.xPosition;
    _yPosition = option.yPosition;

    /*
     i18nExtAlert("ajaxUrl : "+ ajaxUrl +" callbackFunction : " + callbackFunction + " ajaxTimeout : " + ajaxTimeout
     + " isEncription : " + _isEncription + " _useProgressBarYn : " + _useProgressBarYn);
     */
    _isGridMakskYn = option.isGridMakskYn;

    if (_isGridMakskYn == "Y") {
        _useProgressBarYn = "Y";
    }

    //그리드의 loadMask 기능을 off 시킴.. -> 공통적용된 사항(일반 html에서 쓰이는 처리중입니다. 띄우는 걸로 대체함.)
    _isGridMakskYn = "N";
    _gridObject = option.gridObjectName;
    _isGridPaging = option.isGridPaging;

    //영업일달력의 경우, 영업일체크하는 ajax호출을 암호화를 시켜줘야한다.
    if (option.bizChkCalendarEnc) {
        option.encription = true;
        _isEncription = true;
    }

    if( Ext.isIE ){
        // e2e라면 보안 모듈을 확인 한다.
        if (typeof(document.secukey) != "undefined" && document.secukey.object != null) {
            for (var key in DataMap) {
                if( key.indexOf("_E2E123_") > -1 ) continue;
                //
//                if( !Ext.isIE8 ){
                    var secukey = document.secukey;
                    e2e = document.getElementsByName(key)[0];
                    if( secukey != undefined && secukey != null ){
                        if(secukey.INI7E2ESTATE() == 0 && e2e != undefined && e2e != null){
                            if( e2e['type'] == 'password' ){
                                DataMap[key] = e2e.value;
                                DataMap['_E2E123_' + key] = DataMap[key];
                                // DataMap 의 키가 key 인 정보를 삭제 한다.
                                delete DataMap[key];
                            }
                        }
                    } 
//                }
//                else{
//                    // 키 값을 가지고 E2E 인지 확인 한다.
//                    var e2e = document.getElementsByName( '_E2E123_' + key)[0];
//                    if( e2e != undefined && e2e != null ){
//                        DataMap[key] = e2e.value;
//                        DataMap['_E2E123_' + key] = DataMap[key];
//                        // DataMap 의 키가 key 인 정보를 삭제 한다.
//                        delete DataMap[key];
//                    }
//                }

                // 키 값을 가지고 확장 E2E인지 확인 한다.
                e2e = document.getElementsByName( '_ExtE2E123_' + key)[0];
                if( e2e != undefined && e2e != null ){
                    // 확장 E2E인경우 파라메터로 값을 추가 한다.
                    // 확장 E2E는 기본 필드와 확장 E2E필드를 함께 가져가야 복호화가 된다.
                    DataMap['_ExtE2E123_' + key] = e2e.value;
                    delete DataMap[key];
//                    DataMap[key] = e2e.value;
                }
            }
        }
    }

    Action.service(
            ajaxUrl, DataMap,
	    {
	        callback:callbackFunction,
	        timeout:ajaxTimeout,
	        errorHandler:ajaxErrorHandler,
	        async:option.async
	    }
    );
    
}


function executeAction(ajaxUrl, DataMap, callbackFunction, option) {
 _timerStart();

 if (option.encryption == undefined) {
     _isEncription = option.encription;
 } else {
     _isEncription = option.encryption;
 }
 var ajaxTimeout = option.timeout;
 _useProgressBarYn = option.progressBarYn;
 _useModalProgressBarYn = option.modalProgressBarYn;
 _xPosition = option.xPosition;
 _yPosition = option.yPosition;

 /*
  i18nExtAlert("ajaxUrl : "+ ajaxUrl +" callbackFunction : " + callbackFunction + " ajaxTimeout : " + ajaxTimeout
  + " isEncription : " + _isEncription + " _useProgressBarYn : " + _useProgressBarYn);
  */
 _isGridMakskYn = option.isGridMakskYn;

 if (_isGridMakskYn == "Y") {
     _useProgressBarYn = "Y";
 }

 //그리드의 loadMask 기능을 off 시킴.. -> 공통적용된 사항(일반 html에서 쓰이는 처리중입니다. 띄우는 걸로 대체함.)
 _isGridMakskYn = "N";
 _gridObject = option.gridObjectName;
 _isGridPaging = option.isGridPaging;

 //영업일달력의 경우, 영업일체크하는 ajax호출을 암호화를 시켜줘야한다.
 if (option.bizChkCalendarEnc) {
     option.encription = true;
     _isEncription = true;
 }

ajaxProgressBarShowHide(true);

if(option.encodingYn == "Y"){
	for(key in DataMap) {
		DataMap[key] = encodeURIComponent(DataMap[key]);
	}	
}

 var _async			= option.async;
 var _dataType 		= "json";
 var _data 			= DataMap;
 var _contentType 	= "application/x-www-form-urlencoded;charset=euc-kr";
 var _headers		= {'X-Ajax-Error-Accept': 'application/json'};
 
try {
 document.characterSet = "euc-kr";
}
catch (e) {
 document.charset = "euc-kr";
}
 
 jQuery.ajax({
	 	url			: ajaxUrl,
		type		: "POST",
		async		: _async,
		dataType	: _dataType,
		contentType : _contentType,
	    headers		: _headers,
		data		: _data,
		cache		: false,
		beforeSend: function(jqXHR) {
			jqXHR.overrideMimeType(_contentType);
		},
		success: function (data, textStatus, jqXHR) {
			ajaxProgressBarShowHide(false);
			 
			if (typeof callbackFunction == "function") {
				callbackFunction(data.dataMap);
			}
		},
		complete: function (jqXHR, textStatus) {
			//console.log('[complete]:');
		},
		error: function (jqXHR, textStatus, errorThrown) {
			ajaxProgressBarShowHide(false);
			 
			if (typeof callback == "function") {
				//alert(jqXHR.responseText.replace(/\&(?!(amp;|#))/g, "&amp;"));
				ajaxErrorHandler(jqXHR.responseText.replace(/\&(?!(amp;|#))/g, "&amp;"));
			}
		},
		//error: ajaxErrorHandler,
		timeout: ajaxTimeout
	});
}


function ajaxProgressBarShowHide(isShow)
{
	if(isShow == undefined) isShow = true;
    if (_useProgressBarYn == "Y" || _useModalProgressBarYn == "Y") {
    	try{
			 if(isShow) spider.extJS.loadingLayer.show();
			 else spider.extJS.loadingLayer.close();
    	}catch(e){}
    }
}

function ajaxErrorHandler(message) {
	ajaxProgressBarShowHide(false);
	
    if (_gridObject != "") {
        //if(_isGridMakskYn == "Y"){	// 그리드내 mask사용여부 - 그리드의 mask 사용 안함 2009.05.19 - 김보라
        if (_isGridPaging == "Y") {    // 그리드 페이징 사용여부
            // ExtGridCommon.js
            gridLoadMaskView(_gridObject, false, true);		//grid mask hidden
        } else {
            // ExtGridCommon.js
            gridLoadMaskView(_gridObject, false, false);		//grid mask hidden
        }
        //}
    }
    // JHSCICommon.js
    if("EN" == _fU_localeCode){
    	i18nExtAlert(message, "", "", "EN");
    }else{
    	i18nExtAlert(message);
    }
}

/**
 * Ajax 호출시 세션 아웃 발생시  띄우는 스크립트
 * @param dataMap : 오류정보가 들어있는 dataMap
 */
function ajaxLoginException(dataMap) {
    var ajaxErrorMsg = dataMap.RESPONSE_MESSAGE + "[" + dataMap.ERROR_CODE + "]";
    var ajaxErrorTitle = dataMap.ERROR_TITLE;
    if (dataMap.LOCALE_CODE != undefined && dataMap.LOCALE_CODE == "EN") {
		if (dataMap.ERROR_TRX_ID != undefined && dataMap.ERROR_TRX_ID != "") {
			if (		//dataMap.ERROR_TRX_ID=="SQBA5446I044" || dataMap.ERROR_TRX_ID=="SQBA5446I045"|| dataMap.ERROR_TRX_ID=="SQBA5446I046"
						dataMap.ERROR_TRX_ID=="SQBA5601I000" || dataMap.ERROR_TRX_ID=="SQBA5601I001"|| dataMap.ERROR_TRX_ID=="SQBA5601I002"
					 || dataMap.ERROR_TRX_ID=="SQBA5601I001" || dataMap.ERROR_TRX_ID=="SQBA5601I002"|| dataMap.ERROR_TRX_ID=="SQBL4030A002" 
					 || dataMap.ERROR_TRX_ID=="SQBL4041A000" || dataMap.ERROR_TRX_ID=="SQBL4202A000"|| dataMap.ERROR_TRX_ID=="SQBL4210A000" 
					 || dataMap.ERROR_TRX_ID=="SQBL4210A011" || dataMap.ERROR_TRX_ID=="SQBL4349I090"|| dataMap.ERROR_TRX_ID=="SQBL4349I091" 
					 || dataMap.ERROR_TRX_ID=="SQBP4200A000" || dataMap.ERROR_TRX_ID=="SQBP4230I000"|| dataMap.ERROR_TRX_ID=="SQBP4231A000" 
					 || dataMap.ERROR_TRX_ID=="SQBP4231A011" || dataMap.ERROR_TRX_ID=="SQBP4262A000"|| dataMap.ERROR_TRX_ID=="SQBP4262A001" 
					 || dataMap.ERROR_TRX_ID=="SQCM1220A000" || dataMap.ERROR_TRX_ID=="SQCM1248A000"|| dataMap.ERROR_TRX_ID=="SQCM1395I051" 
					 || dataMap.ERROR_TRX_ID=="SQCM1395N003" || dataMap.ERROR_TRX_ID=="SQCP1735I000"|| dataMap.ERROR_TRX_ID=="SQCP1750A001" 
					 || dataMap.ERROR_TRX_ID=="SQCP1770A000" || dataMap.ERROR_TRX_ID=="SQCP1802A000"|| dataMap.ERROR_TRX_ID=="SQCP1890I000" 
					 || dataMap.ERROR_TRX_ID=="SQIC3700A000" || dataMap.ERROR_TRX_ID=="SQIC3900A000"|| dataMap.ERROR_TRX_ID=="SQPD2084A000" 
					 || dataMap.ERROR_TRX_ID=="SQPD2089A000" || dataMap.ERROR_TRX_ID=="SQPD2118A000"|| dataMap.ERROR_TRX_ID=="SQPD2150A003" 
					 || dataMap.ERROR_TRX_ID=="SQPD2150A005" || dataMap.ERROR_TRX_ID=="SQPD2291I019"|| dataMap.ERROR_TRX_ID=="SQBL4210A017"  	
					) {
				ajaxErrorMsg = dataMap.SUB_ERROR_MESSAGE;
				ajaxErrorTitle = "[Notice]";
			} else if (dataMap.ERROR_TRX_ID=="SQCAH401A000" && ( 
					   dataMap.ERROR_CODE=="BEBK00220" || dataMap.ERROR_CODE=="BEBK00400" || dataMap.ERROR_CODE=="BEBK00410" || 
					   dataMap.ERROR_CODE=="BEBK00420" || dataMap.ERROR_CODE=="BEBK00430" || dataMap.ERROR_CODE=="BEBK00440" || 
					   dataMap.ERROR_CODE=="BEBK00500" || dataMap.ERROR_CODE=="BEBK00510" || dataMap.ERROR_CODE=="BEBK00520")
					  ){
				// ERROR_CODE 에의해 스파이더 에서 번역된값 받음. 
			} else {
				ajaxErrorMsg = "An error occurred during your Transaction, If you have an inquiry, please contact the Customer Center 1800-1111. Hours Available: Weekdays 9:00 AM~ 6:00 PM";
				ajaxErrorTitle = "[Notice]";
			} 
		}
    } 
    //ajaxErrorMsg = ajaxErrorMsg + "<img src ='../shared/icons/fam/application_go.png' border=0 alt='로그인 페이지로 이동' onClick='goLoginPage();'>";
//    // JHSCICommon.js
    i18nExtAlertFn(ajaxErrorMsg, ajaxErrorTitle, goLoginPage);
}

/**
 * Ajax 호출시 세션 아웃 발생시  띄우는 스크립트
 * @param dataMap : 오류정보가 들어있는 dataMap
 */
function ajaxLoginExceptionPop(dataMap) {
    var ajaxErrorMsg = dataMap.RESPONSE_MESSAGE + "[" + dataMap.ERROR_CODE + "]";
    //ajaxErrorMsg = ajaxErrorMsg + "<img src ='../shared/icons/fam/application_go.png' border=0 alt='로그인 페이지로 이동' onClick='goLoginPagePop();'>";
    // JHSCICommon.js
    i18nExtAlertFn(ajaxErrorMsg, dataMap.ERROR_TITLE, goLoginPagePop);
}


function goLoginPage() {
    var com_frm = document.getElementById("_com_frm");
    com_frm.action = _loginPageURI;
    if (_afterLoginValue != "") {
        com_frm._$QUERY_STRING.value = _afterLoginValue + '&forwardValue=INVALID_SESSION_AUTO';
    }
    com_frm.submit();
    com_frm._$QUERY_STRING.value = "";
}

function goLoginPagePop() {
    document._com_frm.action = _loginPageURI;
    //if(_isEncription){
    //	opener._com_frm.spiderSubmit();
    //}else{
    opener._com_frm.submit();
    //}
}

function ajaxIsLogin(dataMap) {
    var _$isLogin = true;
    if ("FRU00001" == dataMap.ERROR_CODE) {
        _$isLogin = false;
    }
    return _$isLogin;
}
 
function checkDataMap(dataMap) {
	try {
	return eval(dataMap);
	}catch(e){}
	return dataMap;
}